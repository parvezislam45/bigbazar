{% extends 'base.html' %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-950 to-black text-white px-6 py-12 font-sans">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-center text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 via-pink-500 to-purple-400 mb-12">
            üõí Secure Checkout
        </h1>

        {% if messages %}
            <div class="bg-red-500/30 border border-red-400 text-white p-4 rounded-xl mb-6 shadow-lg backdrop-blur-md">
                {% for message in messages %}
                    <p class="flex items-center gap-2"><svg class="w-5 h-5 text-red-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-12.728 12.728M5.636 5.636l12.728 12.728"/></svg> {{ message }}</p>
                {% endfor %}
            </div>
        {% endif %}

        <form method="POST" class="grid md:grid-cols-2 gap-10">
            {% csrf_token %}
            <input type="hidden" name="product_name" value="{{ product.product_name }}">

            <!-- Product Summary -->
            <div class="bg-white/5 backdrop-blur-xl border border-white/10 rounded-3xl p-6 shadow-xl space-y-6">
                <img src="{{ image_url }}" alt="{{ product.product_name }}" class="w-52 h-64 mx-auto object-cover rounded-xl shadow-md">
                <div>
                    <h2 class="text-3xl font-bold text-indigo-300 mb-2 text-center"><svg class="w-6 h-6 inline-block mr-2 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M3 3h18v18H3V3z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/></svg>{{ product.product_name }}</h2>
                    <p class="text-gray-300 text-center font-semibold text-md">Quantity : <span class='text-sm mx-3'>{{ quantity }}</span></p>
                    <p class="text-gray-300 text-center font-semibold text-md">Price: <span class='text-sm mx-3'>{{ product.price }} √ó {{ quantity }}</span></p>
                    <p class="text-gray-300 text-center font-semibold text-md">Subtotal: <span class='text-sm mx-3'>{{ subtotal }}</span></p>
                    <p class="text-gray-300 text-center font-semibold text-md">Shipping: <span class='text-sm mx-3'>{{ shipping_charge }}</span></p>
                    <p class="text-2xl font-semibold text-pink-400 mt-4 text-center">Total: {{ total_price }}</p>
                </div>
            </div>

            <!-- Shipping + Payment -->
            <div class="bg-white/5 backdrop-blur-xl border border-white/10 rounded-3xl p-6 shadow-xl space-y-6">
                <h2 class="text-2xl font-bold text-pink-400 mb-4">
                    <svg class="w-6 h-6 inline-block mr-2 text-pink-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a9 9 0 00-9 9h18a9 9 0 00-9-9z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/></svg>
                    Shipping Info
                </h2>

                <div class="space-y-4">
                    <input type="text" name="name" placeholder="Full Name" required
                           value="{{ form_data.name }}" 
                           class="w-full bg-black/30 p-3 rounded-xl border border-white/10 focus:ring-2 focus:ring-indigo-400 text-white placeholder-gray-400">
                    <input type="text" name="phone" placeholder="Phone Number" required
                           value="{{ form_data.phone }}" 
                           class="w-full bg-black/30 p-3 rounded-xl border border-white/10 focus:ring-2 focus:ring-indigo-400 text-white placeholder-gray-400">
                    <textarea name="address" rows="3" placeholder="Address" required
                              class="w-full bg-black/30 p-3 rounded-xl border border-white/10 focus:ring-2 focus:ring-indigo-400 text-white placeholder-gray-400">{{ form_data.address }}</textarea>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="text" name="city" placeholder="City" required
                               value="{{ form_data.city }}"
                               class="w-full bg-black/30 p-3 rounded-xl border border-white/10 focus:ring-2 focus:ring-indigo-400 text-white placeholder-gray-400">
                        <input type="text" name="street" placeholder="Street" required
                               value="{{ form_data.street }}"
                               class="w-full bg-black/30 p-3 rounded-xl border border-white/10 focus:ring-2 focus:ring-indigo-400 text-white placeholder-gray-400">
                    </div>
                    <input type="text" name="country" placeholder="Country" required
                           value="{{ form_data.country }}" 
                           class="w-full bg-black/30 p-3 rounded-xl border border-white/10 focus:ring-2 focus:ring-indigo-400 text-white placeholder-gray-400">
                </div>

                <input type="hidden" name="total_quantity" value="{{ quantity }}">

                <!-- Payment -->
                <h2 class="text-2xl font-bold text-indigo-400 mt-6">
                    <svg class="w-6 h-6 inline-block mr-2 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M17 9V7a4 4 0 00-8 0v2M5 11h14a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/></svg>
                    Payment Method
                </h2>

                <div class="space-y-3">
                    <label class="flex items-center gap-3">
                        <input type="radio" name="payment_method" value="cod" id="cod"
                               {% if form_data.payment_method == 'cod' %}checked{% endif %}
                               class="accent-pink-500">
                        <span>üíµ Cash on Delivery</span>
                    </label>
                    <label class="flex items-center gap-3">
                        <input type="radio" name="payment_method" value="online" id="online"
                               {% if not form_data.payment_method or form_data.payment_method == 'online' %}checked{% endif %}
                               class="accent-indigo-500">
                        <span>üí≥ Online Payment</span>
                    </label>
                    <label class="flex items-center gap-3">
                        <input type="radio" name="payment_method" value="emi" id="emi"
                               {% if form_data.payment_method == 'emi' %}checked{% endif %}
                               class="accent-teal-400">
                        <span>üè¶ EMI</span>
                    </label>
                </div>

                <!-- COD -->
                <div id="cod-field" style="display: {% if form_data.payment_method == 'cod' %}block{% else %}none{% endif %};">
                    <label class="block text-sm text-gray-300 mt-4">Transaction ID</label>
                    <input type="text" name="transaction_id" 
                           value="{{ form_data.transaction_id }}"
                           class="w-full bg-black/30 p-3 rounded-xl border border-white/10 focus:ring-2 focus:ring-pink-400 text-white placeholder-gray-400">
                </div>

                <!-- EMI -->
                <div id="emi-field" class="space-y-4 mt-4"
                     style="display: {% if form_data.payment_method == 'emi' %}block{% else %}none{% endif %};">
                    {% if user.is_authenticated %}
                        <div>
                            <label class="text-sm text-gray-300">Bank Name</label>
                            <input type="text" name="emi_bank" value="{{ form_data.emi_bank }}"
                                   class="w-full bg-black/30 p-3 rounded-xl border border-white/10 focus:ring-2 focus:ring-teal-400 text-white placeholder-gray-400">
                        </div>
                        <div>
                            <label class="text-sm text-gray-300">EMI Duration (months)</label>
                            <input type="number" name="emi_duration" value="{{ form_data.emi_duration }}"
                                   class="w-full bg-black/30 p-3 rounded-xl border border-white/10 focus:ring-2 focus:ring-teal-400 text-white placeholder-gray-400">
                        </div>
                    {% else %}
                        <div class="bg-yellow-400/20 text-yellow-300 p-3 rounded-xl text-sm">
                            <a href="{% url 'login' %}?next={% url 'order-form' %}" class="underline text-yellow-200">Login</a> required for EMI options.
                        </div>
                    {% endif %}
                </div>

                <button type="submit"
                        class="mt-6 w-full py-3 rounded-xl text-lg font-bold bg-gradient-to-r from-pink-500 via-indigo-500 to-purple-500 hover:from-indigo-500 hover:to-pink-500 transition duration-300 shadow-xl">
                    üöÄ Place Order
                </button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const paymentFields = {
        'cod': document.getElementById('cod-field'),
        'emi': document.getElementById('emi-field')
    };
    document.querySelectorAll('input[name="payment_method"]').forEach(radio => {
        radio.addEventListener('change', () => {
            Object.values(paymentFields).forEach(field => {
                if (field) field.style.display = 'none';
            });
            if (paymentFields[radio.value]) {
                paymentFields[radio.value].style.display = 'block';
            }
        });
    });
});
</script>
{% endblock %}
